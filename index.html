<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GoTravel</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a73e8">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
    
    <style>
        :root { --uk-red: #CC0000; --drive-blue: #1a73e8; --asda-green: #78be20; --tesco-blue: #00539f; --sains-orange: #f06c00; }
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Roboto, sans-serif; overflow: hidden; background: #f4f7f6; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; z-index: 1; }
        .leaflet-routing-container { display: none !important; }

        /* --- SEARCH UI --- */
        .search-container {
            position: absolute; top: 15px; left: 50%; transform: translateX(-50%);
            width: 92%; max-width: 480px; z-index: 1000;
        }
        #search-input {
            width: 100%; padding: 15px 22px; border-radius: 30px; border: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); font-size: 16px; outline: none; box-sizing: border-box;
        }

        .quick-tags {
            display: flex; gap: 8px; margin-top: 10px; overflow-x: auto; padding-bottom: 5px;
            scrollbar-width: none;
        }
        .quick-tags::-webkit-scrollbar { display: none; }
        
        .tag {
            white-space: nowrap; padding: 8px 16px; border-radius: 20px; 
            background: white; font-size: 13px; font-weight: bold; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); cursor: pointer; border: 1px solid #ddd;
        }

        #results-list {
            display: none; background: white; margin-top: 8px; border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15); overflow: hidden; max-height: 300px; overflow-y: auto;
        }
        .result-item { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; }
        .result-item b { display: block; color: #111; }
        .result-item span { font-size: 12px; color: #666; }

        /* --- SPEED & DASHBOARD --- */
        #speed-sign {
            position: absolute; bottom: 150px; left: 20px;
            width: 65px; height: 65px; background: white;
            border: 7px solid var(--uk-red); border-radius: 50%;
            display: none; flex-direction: column; justify-content: center; align-items: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1000;
        }
        .speed-val { font-size: 24px; font-weight: 900; color: #000; line-height: 1; }
        #nav-panel {
            display: none; position: absolute; bottom: 0; width: 100%; z-index: 1000;
            background: white; border-top-left-radius: 25px; border-top-right-radius: 25px;
            padding: 20px; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); box-sizing: border-box;
        }
        .nav-flex { display: flex; align-items: center; justify-content: space-between; }
        .end-btn { margin-left: 15px; background: #fee2e2; color: #d33; border: none; padding: 12px; border-radius: 12px; font-weight: bold; cursor: pointer; }

        /* LOCATION ERROR OVERLAY */
        #loc-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%; background:white;
            z-index: 5000; display: flex; flex-direction: column; justify-content: center; align-items: center;
            text-align: center; padding: 20px; box-sizing: border-box;
        }
        .loc-btn { background: var(--drive-blue); color: white; padding: 15px 30px; border-radius: 30px; border: none; font-weight: bold; margin-top: 20px; font-size: 18px; }
    </style>
</head>
<body>

    <div id="loc-overlay">
        <h2>Location Required</h2>
        <p>Please allow location access to use the navigator.</p>
        <button class="loc-btn" onclick="requestLocation()">Enable GPS</button>
    </div>

    <div id="map"></div>

    <div class="search-container">
        <input type="text" id="search-input" placeholder="Search Tesco, Asda, etc..." autocomplete="off">
        <div class="quick-tags">
            <div class="tag" onclick="quickSearch('Tesco')" style="color:var(--tesco-blue)">ðŸ”µ Tesco</div>
            <div class="tag" onclick="quickSearch('Sainsbury\'s')" style="color:var(--sains-orange)">ðŸŸ  Sainsbury's</div>
            <div class="tag" onclick="quickSearch('Asda')" style="color:var(--asda-green)">ðŸŸ¢ Asda</div>
            <div class="tag" onclick="quickSearch('Morrisons')" style="color:#00553e">ðŸŸ¡ Morrisons</div>
        </div>
        <div id="results-list"></div>
    </div>

    <div id="speed-sign">
        <span class="speed-val" id="speed-num">0</span>
        <span class="speed-unit" style="font-size:9px; font-weight:bold;">MPH</span>
    </div>

    <div id="nav-panel">
        <div class="nav-flex">
            <p id="instruction" style="font-size:17px; font-weight:700; margin:0; flex:1;">Ready</p>
            <div style="text-align:right; min-width:80px;">
                <p id="eta" style="font-size:22px; font-weight:800; color:#1e8e3e; margin:0;">--</p>
                <p id="miles" style="font-size:12px; color:#666; margin:0;">-- mi</p>
            </div>
            <button class="end-btn" onclick="location.reload()">END</button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

    <script>
        const map = L.map('map', { zoomControl: false }).setView([51.5, -0.1], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        let userLoc = [51.5, -0.1];
        let destination = null;
        let routeCtrl = null;
        const userMarker = L.circleMarker(userLoc, { color: 'white', fillColor: '#1a73e8', fillOpacity: 1, radius: 9, weight: 3 }).addTo(map);

        // --- GPS LOGIC ---
        function requestLocation() {
            navigator.geolocation.getCurrentPosition(
                (p) => {
                    document.getElementById('loc-overlay').style.display = 'none';
                    updatePos(p);
                    // Start constant tracking
                    navigator.geolocation.watchPosition(updatePos, (e) => console.log(e), { enableHighAccuracy: true });
                },
                (err) => {
                    alert("Please enable location in your browser settings.");
                },
                { enableHighAccuracy: true }
            );
        }

        function updatePos(p) {
            userLoc = [p.coords.latitude, p.coords.longitude];
            userMarker.setLatLng(userLoc);
            if (!routeCtrl) map.setView(userLoc, 15);
            
            if (document.getElementById('speed-sign').style.display === 'flex') {
                document.getElementById('speed-num').innerText = p.coords.speed ? Math.round(p.coords.speed * 2.237) : 0;
            }
        }

        // --- SEARCH & NAV ---
        function quickSearch(query) { performSearch(query); }
        document.getElementById('search-input').addEventListener('input', function() {
            if (this.value.length >= 3) performSearch(this.value);
        });

        function performSearch(query) {
            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&addressdetails=1&limit=10&lat=${userLoc[0]}&lon=${userLoc[1]}&countrycodes=gb`;
            fetch(url).then(r => r.json()).then(data => {
                const list = document.getElementById('results-list');
                list.innerHTML = '';
                list.style.display = 'block';
                
                data.forEach(item => {
                    const dist = getMiles(userLoc[0], userLoc[1], item.lat, item.lon);
                    const div = document.createElement('div');
                    div.className = 'result-item';
                    div.innerHTML = `<b>${item.display_name.split(',')[0]}</b><span>${dist.toFixed(1)} miles away</span>`;
                    div.onclick = () => startNav(item);
                    list.appendChild(div);
                });
            });
        }

        function getMiles(lat1, lon1, lat2, lon2) {
            const R = 3958.8;
            const dLat = (lat2-lat1) * Math.PI/180;
            const dLon = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function startNav(item) {
            document.getElementById('results-list').style.display = 'none';
            document.querySelector('.search-container').style.display = 'none';
            document.getElementById('nav-panel').style.display = 'block';
            document.getElementById('speed-sign').style.display = 'flex';

            if (routeCtrl) map.removeControl(routeCtrl);
            routeCtrl = L.Routing.control({
                waypoints: [L.latLng(userLoc[0], userLoc[1]), L.latLng(item.lat, item.lon)],
                router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1' }),
                lineOptions: { styles: [{ color: '#1a73e8', weight: 8 }] },
                show: false
            }).addTo(map);

            routeCtrl.on('routesfound', (e) => {
                const r = e.routes[0];
                document.getElementById('eta').innerText = Math.round(r.summary.totalTime/60) + 'm';
                document.getElementById('miles').innerText = (r.summary.totalDistance/1609.34).toFixed(1) + ' mi';
                document.getElementById('instruction').innerText = r.instructions[0].text;
                const u = new SpeechSynthesisUtterance(r.instructions[0].text);
                u.lang = 'en-GB';
                window.speechSynthesis.speak(u);
            });
        }

        // Run GPS request on load
        requestLocation();
    </script>
</body>
</html>
